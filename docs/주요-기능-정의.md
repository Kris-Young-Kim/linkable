# LinkAble (링케이블) - 주요 기능 정의

**프로젝트명**: LinkAble (링케이블)  
**버전**: v1.2  
**작성일**: 2025.01.XX  
**작성자**: 에이블 코디 팀

---

## 목차

1. [기능 개요](#1-기능-개요)
2. [핵심 기능 상세](#2-핵심-기능-상세)
3. [보조 기능](#3-보조-기능)
4. [기능 우선순위](#4-기능-우선순위)

---

## 1. 기능 개요

LinkAble의 주요 기능은 **활동 분석(Activity Analysis)** 프레임워크에 따라 4단계로 구성됩니다:

1. **문제 호소 (Assessment)**: AI 상담을 통한 문제 파악 및 ICF 코드 추출
2. **해결책 탐색 (Matching)**: ISO 9999 표준 기반 보조기기 매칭 및 추천
3. **구매 실행 (Action)**: 추천 상품을 외부 커머스로 연결
4. **가치 검증 (Validation)**: K-IPPA 평가를 통한 효과성 검증

---

## 2. 핵심 기능 상세

### 2.1 AI 코디네이터 '링커' (AI Core)

#### 2.1.1 채팅 인터페이스

**기능 설명**: 사용자와 AI 코디네이터 '링커'가 대화하며 문제를 파악하는 인터페이스

**주요 기능**:
- ✅ 텍스트 입력 및 기본 채팅 UI
- ✅ 실시간 스트리밍 응답 (Next.js AI SDK)
- ✅ STT(Speech-to-Text): Web Speech API를 활용한 음성 입력
- ✅ Image Input: Gemini Vision API를 통한 환경(문턱, 계단 등) 사진 분석
- ✅ ICF 분석 결과 시각화 컴포넌트

**입력값**:
- `message`: 텍스트 메시지 (필수, 최대 1000자)
- `audio`: 음성 입력 (선택, Web Speech API)
- `image`: 이미지 파일 (선택, 최대 5MB, image/*)

**출력값**:
- `text`: AI 응답 텍스트 (스트리밍)
- `icf_analysis`: ICF 코드 분석 결과 (JSON)
- `followUpQuestions`: 추가 질문 목록

**예외 처리**:
- 메시지 길이 초과: "메시지는 1000자 이하로 입력해주세요"
- 음성 인식 실패: "음성 인식을 실패했습니다. 다시 시도해주세요"
- 이미지 크기 초과: "이미지는 5MB 이하로 업로드해주세요"
- AI 응답 오류: "상담 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요"

#### 2.1.2 프롬프트 로직

**시스템 프롬프트**: "너는 16년 차 보조공학 코디네이터야. 의료 용어를 쓰지 말고 기능 중심으로 말해."

**구조화된 출력**: AI 응답은 반드시 아래 JSON 포맷을 포함해야 함 (DB 저장용)

```json
{
  "icf_analysis": {
    "b": ["b765"],
    "d": ["d550"],
    "e": []
  },
  "iso_recommendation": ["15 09 13"],
  "reasoning": "손 떨림을 보정하기 위해 무게감 있는 식사 도구를 추천합니다."
}
```

**가드레일**: 의료 행위를 기술적으로 차단
- "If the user asks for a diagnosis or medical treatment, explicitly state: 'I am a coordinator, not a doctor. Please consult a medical professional.' and do NOT provide medical advice."

---

### 2.2 스마트 매칭 엔진 (Recommendation Engine)

#### 2.2.1 ICF-ISO 매핑

**기능 설명**: AI가 추출한 ICF 코드를 ISO 9999 코드로 자동 변환

**로직**:
- d-code(활동)와 e-code(환경)를 조합하여 ISO 매칭
- 예: d450(걷기) + e120(단차) → ISO 18 12 10(이동식 경사로)

**구현 상태**:
- ✅ AI가 추출한 d-code와 e-code를 조합하여 ISO 매칭 구현 완료
- ✅ DB products 테이블에서 해당 패턴을 해결하는 iso_code 검색 구현 완료
- ✅ Fallback: 정확한 매칭이 없을 경우, 상위 카테고리(Sub-class) 수준에서 검색 구현 완료

#### 2.2.2 상품 필터링 및 랭킹

**필터링**: AI가 추출한 iso_code와 DB의 products 테이블 내 iso_code 일치 항목 검색 (SQL Query)

**랭킹**: 유사 상품 노출 시 '클릭률'과 '평점' 가중치 반영 (MVP에서는 랜덤 or 등록순)

**표시**: 상품 카드에 [ISO 인증], [해결 가능 문제] 태그 자동 부착

#### 2.2.3 추천 페이지

**기능 설명**: 상담 기반 추천 상품 목록을 표시하고 외부 구매 링크로 연결

**주요 기능**:
- 상담 요약 및 ICF 분석 결과 표시
- 필터링 (전체/클릭됨/미클릭)
- 정렬 (추천순/가격 낮은순/가격 높은순/이름순)
- 상품 카드 클릭 시 외부 구매 링크 이동
- 클릭 로그 기록

**입력값**:
- `consultationId`: 상담 ID (URL 파라미터, 필수)
- `filter`: 필터 옵션 (선택, "all" | "clicked" | "not_clicked")
- `sort`: 정렬 옵션 (선택, "recommended" | "price_asc" | "price_desc" | "name")

**예외 처리**:
- 상담 ID 없음: "상담 정보를 찾을 수 없습니다"
- 추천 없음: "아직 추천된 상품이 없습니다"
- 상품 데이터 오류: "상품 정보를 불러오는 중 오류가 발생했습니다"

#### 2.2.4 상담 완료 후 추천 연동

**기능 설명**: ICF 분석 완료 시 채팅 인터페이스에 "추천 보기" CTA 버튼 표시

**구현 상태**:
- ✅ ICF 분석 완료 감지 및 CTA 버튼 표시
- ✅ 클릭 시 `/recommendations/[consultationId]`로 이동
- ✅ 채팅 내 추천 카드 미리보기 (상위 2-3개)

---

### 2.3 K-IPPA 평가 시스템 (Validation)

#### 2.3.1 기초선 평가 (Baseline Evaluation)

**기능 설명**: 보조기기 사용 전 현재 상태를 평가하는 기초선 인터뷰

**평가 시점**: 
- 추천 페이지에서 제안 (사용자가 선택적으로 진행)
- 채팅 중간에 폼이 나타나지 않음 (사용자 여정 개선)

**평가 항목**:
- AI가 상담 내용에서 추출한 ICF D-Level 활동 코드
- 각 활동에 대한 중요도 (1~5점)
- 각 활동에 대한 현재 어려움 정도 (1~5점)

**구현 상태**:
- ✅ 추천 페이지에 기초선 평가 제안 카드 표시
- ✅ 기초선 평가 전용 페이지 (`/dashboard/ippa/baseline/[consultationId]`)
- ✅ AI 추출 ICF 코드 기반 평가 폼
- ✅ 평가 완료 여부 확인 및 상태 표시

#### 2.3.2 사후 평가 트리거

**기능 설명**: recommendations 테이블 생성일 기준 +14일 뒤 알림 발송

**구현 상태**:
- ✅ CRON 작업 설계 완료
- ⚠️ 실제 알림 발송 시스템 (구현 필요)

#### 2.3.3 사후 평가 UI

**기능 설명**: 보조기기 사용 후 효과성을 평가하는 설문 폼

**질문 항목**:
- Q1. 해결하고자 했던 문제 (AI가 요약한 내용 자동 입력)
- Q2. 중요도 (1~5점 별점) - 기초선 평가에서 입력한 값 사용
- Q3. 사용 전 수행 난이도 vs 사용 후 수행 난이도 (슬라이더 UI)
- Q4. 추가 피드백 (선택, 최대 500자)

**입력값**:
- `recommendationId`: 추천 ID (URL 파라미터, 필수)
- `pre_score`: 사용 전 점수 (필수, 1-5)
- `post_score`: 사용 후 점수 (필수, 1-5)
- `importance`: 중요도 (필수, 1-5)
- `feedback`: 추가 피드백 (선택, 최대 500자)

**예외 처리**:
- 점수 미입력: "모든 점수를 입력해주세요"
- 점수 범위 오류: "점수는 1-5 사이의 값이어야 합니다"
- 제출 실패: "평가 제출에 실패했습니다. 다시 시도해주세요"

#### 2.3.3 점수 계산

**로직**: `effect_score = (pre_score - post_score) * importance`

**저장**: 
- `ippa_evaluations` 테이블에 저장
- `users.points` 업데이트 (Transaction 처리 필수)

**효과성 등급**:
- 우수: 15점 이상
- 양호: 10-14점
- 보통: 5-9점
- 미미: 1-4점
- 없음: 0점
- 악화: 음수

#### 2.3.4 평가 히스토리

**기능 설명**: 이전 평가와 비교하여 점수 변화 추이 확인

**주요 기능**:
- 최근 평가와 이전 평가 비교
- 평가 히스토리 목록 표시 (날짜, 점수, 피드백)
- 효과성 등급 표시

---

### 2.4 분석 결과 리포트

#### 2.4.1 상담 리포트 페이지

**기능 설명**: 상담 요약 및 ICF 분석 결과 전체를 시각화하여 표시

**주요 기능**:
- ICF 분석 결과 전체 시각화 (b, d, e 코드별 분류)
- 분석 요약 및 환경 요소 분석 결과 표시
- 생성된 추천 목록 링크
- PDF 다운로드 기능 (선택적)

**입력값**:
- `id`: 상담 ID (URL 파라미터, 필수)

#### 2.4.2 상담 상세 페이지

**기능 설명**: 상담 메시지 전체 히스토리 및 분석 결과 상세 확인

**주요 기능**:
- 상담 메시지 전체 히스토리
- 분석 결과 상세 확인 (ICF 시각화 포함)
- 생성된 추천 목록 및 상태
- K-IPPA 평가 상태
- 상담 리포트 및 추천 목록으로 이동하는 CTA 버튼

#### 2.4.3 ICF 코드 상세 설명

**기능 설명**: ICF 코드 클릭 시 상세 설명 툴팁/모달 표시

**주요 기능**:
- 코드 클릭 시 설명 툴팁/모달
- 카테고리별 색상 구분 (b=파랑, d=초록, e=주황)
- 관련 ISO 코드 연결 표시
- ICF 설명 및 카테고리 정보 포함

---

## 3. 보조 기능

### 3.1 인증 및 계정 관리

#### 3.1.1 소셜 로그인

**기능 설명**: Clerk를 활용한 소셜 로그인

**지원 플랫폼**:
- 카카오
- 구글
- GitHub

#### 3.1.2 역할 선택

**기능 설명**: 회원가입 시 '사용자(당사자)' vs '보호자/전문가' 유형 선택

**역할 유형**:
- `user`: 일반 사용자
- `admin`: 관리자
- `expert`: 전문가

**저장**: 초기 설정 시 Role을 Clerk 메타데이터에 저장

### 3.2 사용자 대시보드

#### 3.2.1 내 상담

**기능 설명**: 개인 상담 이력 확인 및 이어서 진행

**주요 기능**:
- 상담 이력 리스트 (최근 10개)
- 각 상담 카드 클릭 시 상세 페이지로 이동
- K-IPPA 평가 대상 추천 표시
- 상담 상태 및 추천 현황 표시

#### 3.2.2 개인 효과성 대시보드

**기능 설명**: 개인의 K-IPPA 평가 데이터 및 효과성 추이 확인

**주요 기능**:
- 평균 효과성 점수
- 점수 변화 추이
- 평가 히스토리

### 3.3 관리자 대시보드

#### 3.3.1 전체 플랫폼 통계

**기능 설명**: 전체 플랫폼의 통계 데이터 확인

**주요 지표**:
- 총 사용자 수
- 총 상담 수
- 총 추천 수
- K-IPPA 평가 수

#### 3.3.2 사용자별 종합 데이터

**기능 설명**: 사용자별 상세 데이터 확인

**주요 정보**:
- 사용자 이름, 이메일, 역할
- 상담 수 (전체/완료)
- 추천 수 (전체/클릭)
- K-IPPA 평가 수 및 기록 수
- 평균 효과성 점수
- 점수 변화 추이 (상승/하락 화살표)
- 포인트 현황

**필터링**:
- 전체 사용자
- K-IPPA 평가 완료
- 활성 사용자

**접근 제어**: Clerk role 기반 (admin/expert만 접근)

---

## 4. 기능 우선순위

### 4.1 MVP 필수 기능 (P0)

1. ✅ AI 상담 인터페이스 (텍스트 입력)
2. ✅ ICF 코드 추출
3. ✅ ISO 매칭 및 추천
4. ✅ 추천 페이지
5. ✅ 외부 구매 링크 연결
6. ✅ K-IPPA 평가 시스템
7. ✅ 사용자 대시보드

### 4.2 MVP 중요 기능 (P1)

1. ✅ 실시간 스트리밍 응답
2. ✅ 음성 입력 (STT)
3. ✅ 이미지 입력 (Gemini Vision)
4. ✅ ICF 분석 결과 시각화
5. ✅ 상담 완료 후 추천 연동
6. ✅ 채팅 내 추천 카드 미리보기
7. ✅ 상담 리포트 페이지
8. ✅ 상담 상세 페이지
9. ✅ 관리자 대시보드

### 4.3 Post-MVP 기능 (P2)

1. ⚠️ K-IPPA 자동 알림 (+14일 리마인더)
2. ⚠️ PDF 다운로드 기능
3. ⚠️ Analytics & Metrics (추천 정확도, K-IPPA 참여율 트래킹)
4. ⚠️ 커뮤니티 기능
5. ⚠️ 직접 결제 시스템 (PG 연동)

---

## 5. 기능별 구현 상태

### 5.1 완료된 기능 (✅)

- AI 상담 인터페이스 (텍스트 입력)
- ICF 코드 추출
- ISO 매칭 및 추천
- 추천 페이지
- 외부 구매 링크 연결
- K-IPPA 평가 시스템
- 사용자 대시보드
- 실시간 스트리밍 응답
- 음성 입력 (STT)
- 이미지 입력 (Gemini Vision)
- ICF 분석 결과 시각화
- 상담 완료 후 추천 연동
- 채팅 내 추천 카드 미리보기
- 상담 리포트 페이지
- 상담 상세 페이지
- 관리자 대시보드

### 5.2 구현 필요 기능 (⚠️)

- K-IPPA 자동 알림 (+14일 리마인더)
- PDF 다운로드 기능
- Analytics & Metrics
- 커뮤니티 기능
- 직접 결제 시스템

---

## 6. 기능별 기술 명세

### 6.1 API 엔드포인트

#### POST /api/chat
- **기능**: AI 상담 및 ICF 코드 추출
- **입력**: `{ messages: Message[], context_image?: string, mediaDescription?: string }`
- **출력**: `{ text: string, icfAnalysis: ICFObject, followUpQuestions: string[] }`

#### GET /api/products
- **기능**: 상담 기반 추천 상품 조회
- **입력**: `consultationId` (쿼리 파라미터)
- **출력**: `{ data: Product[] }`

#### POST /api/ippa/submit
- **기능**: K-IPPA 평가 제출
- **입력**: `{ recommendationId, pre_score, post_score, importance, feedback? }`
- **출력**: `{ effect_score: number, points: number }`

#### GET /api/admin/analytics
- **기능**: 전체 플랫폼 통계 조회
- **접근**: 관리자 권한 필요
- **출력**: `{ totalUsers, totalConsultations, totalRecommendations, totalIppaEvaluations }`

#### GET /api/admin/users
- **기능**: 사용자별 종합 데이터 조회
- **접근**: 관리자 권한 필요
- **출력**: `{ users: UserData[] }`

### 6.2 데이터베이스 스키마

#### 주요 테이블
- `users`: 사용자 정보
- `consultations`: 상담 정보
- `analysis_results`: ICF 분석 결과
- `products`: 보조기기 상품 정보
- `recommendations`: 추천 정보
- `ippa_evaluations`: K-IPPA 평가 결과

---

**문서 버전**: v1.2  
**최종 수정일**: 2025.01.XX  
**다음 검토 예정일**: 2025.02.XX

